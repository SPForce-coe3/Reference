#### Table of contents
  - 사전준비
  - loki-stack (Grafana + Prometheus + Loki) 설치하기
  - Dashboard 구성
  - EKS 로그조회
  - Reference
#### 사전준비
  - #### Helm 설치하기
    - Helm 3.x 이상 설치하기
    ```
    $ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    $ chmod 700 get_helm.sh
    $ ./get_helm.sh
    ```
  - #### loki-stack (Grafana + Prometheus + Loki) 설치하기
    - #### Helm을 이용한 loki-stack 설치하기  
      - loki-stack 설치를 위해 Helm Repository를 추가하기
        ```
        $ helm repo add grafana https://grafana.github.io/helm-charts
        ```
      - Grafana Helm Chart를 다운로드 하기
        ```
        $ git clone https://github.com/grafana/helm-charts.git
        ```
      - values.yaml 파일이 있는 위치로 이동하기
        ```
        $ cd helm-charts/charts/grafana
        ```
      - values.yaml 파일을 열어서 grafna, promtail,loki, prometheus 를 구성하기
        ```
        loki:
          enabled: true
          isDefault: true
          config:
             table_manager:
               retention_deletes_enabled: true
               retention_period: 336h
          persistence:
            enabled: true
            size: 2Gi

        promtail:
          enabled: true
          #config:
          #  lokiAddress: http://{{ .Release.Name }}:3100/loki/api/v1/push

        grafana:
          enabled: true
          service:
            type: LoadBalancer
          sidecar:
            datasources:
              enabled: true
              maxLines: 1000
          image:
            tag: 8.3.5

        prometheus:
          enabled: true
          isDefault: false
        ```
      - loki-stack 설치하기
        ```
        $ helm install loki-stack grafana/loki-stack -f values1.yaml --namespace monitoring
        ```
      - loki-stack 설치한 결과 확인하기
        ```
        $ kubectl get all -n monitoring
        NAME                                                      READY   STATUS    RESTARTS   AGE
        pod/loki-stack-0                                          1/1     Running   0          8h
        pod/loki-stack-grafana-786dd6f8d4-8lfcg                   2/2     Running   0          8h
        pod/loki-stack-kube-state-metrics-5dc88bd87d-psm97        1/1     Running   0          8h
        pod/loki-stack-prometheus-alertmanager-65f65c7546-8tl2v   2/2     Running   0          8h
        pod/loki-stack-prometheus-node-exporter-bt9n6             1/1     Running   0          8h
        pod/loki-stack-prometheus-node-exporter-qdhkv             1/1     Running   0          8h
        pod/loki-stack-prometheus-pushgateway-5f788cc4ff-rf7h9    1/1     Running   0          8h
        pod/loki-stack-prometheus-server-5cf59ccd5b-6jk2z         2/2     Running   0          8h
        pod/loki-stack-promtail-5mgtx                             1/1     Running   0          8h
        pod/loki-stack-promtail-spr6h                             1/1     Running   0          8h

        NAME                                          TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)        AGE
        service/loki-stack                            ClusterIP      10.100.214.206   <none>                                                                         3100/TCP       8h
        service/loki-stack-grafana                    LoadBalancer   10.100.115.40    aad93f089f962469bbda58fd5963e292-2070915556.ap-northeast-2.elb.amazonaws.com   80:31740/TCP   8h
        service/loki-stack-headless                   ClusterIP      None             <none>                                                                         3100/TCP       8h
        service/loki-stack-kube-state-metrics         ClusterIP      10.100.1.116     <none>                                                                         8080/TCP       8h
        service/loki-stack-prometheus-alertmanager    ClusterIP      10.100.176.68    <none>                                                                         80/TCP         8h
        service/loki-stack-prometheus-node-exporter   ClusterIP      None             <none>                                                                         9100/TCP       8h
        service/loki-stack-prometheus-pushgateway     ClusterIP      10.100.217.144   <none>                                                                         9091/TCP       8h
        service/loki-stack-prometheus-server          ClusterIP      10.100.15.151    <none>                                                                         80/TCP         8h

        NAME                                                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
        daemonset.apps/loki-stack-prometheus-node-exporter   2         2         2       2            2           <none>          8h
        daemonset.apps/loki-stack-promtail                   2         2         2       2            2           <none>          8h

        NAME                                                 READY   UP-TO-DATE   AVAILABLE   AGE
        deployment.apps/loki-stack-grafana                   1/1     1            1           8h
        deployment.apps/loki-stack-kube-state-metrics        1/1     1            1           8h
        deployment.apps/loki-stack-prometheus-alertmanager   1/1     1            1           8h
        deployment.apps/loki-stack-prometheus-pushgateway    1/1     1            1           8h
        deployment.apps/loki-stack-prometheus-server         1/1     1            1           8h

        NAME                                                            DESIRED   CURRENT   READY   AGE
        replicaset.apps/loki-stack-grafana-786dd6f8d4                   1         1         1       8h
        replicaset.apps/loki-stack-kube-state-metrics-5dc88bd87d        1         1         1       8h
        replicaset.apps/loki-stack-prometheus-alertmanager-65f65c7546   1         1         1       8h
        replicaset.apps/loki-stack-prometheus-pushgateway-5f788cc4ff    1         1         1       8h
        replicaset.apps/loki-stack-prometheus-server-5cf59ccd5b         1         1         1       8h

        NAME                          READY   AGE
        statefulset.apps/loki-stack   1/1     8h
        ```
      - loki-stack-grafana 비번확인
        ```
        $ kubectl get secret --namespace monitoring loki-stack-grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo
        ```





# Reference
  - https://helm.sh/ko/docs/intro/install (helm 설치)
  - https://ksr930.tistory.com/158 (helm-chart yaml 을 이용한 설치)
  - https://freestrokes.tistory.com (yaml 설정)
  - https://www.eksworkshop.com/intermediate/240_monitoring/prereqs/  (eks Workshop)
  
