#### Table of contents
  - Prerequisites
  - Install Jenkins
  - Reference
#### Prerequisites
  - #### Install Jenkins with Helm v3
    ```
    $ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    $ chmod 700 get_helm.sh
    $ ./get_helm.sh
    ```
  - #### Configure Helm
    ```
    $ helm repo add jenkinsci https://charts.jenkins.io
    $ helm repo update
    $ helm search repo jenkinsci
    ```
  - #### Create a namespace
    ```
    $ kubectl create namespace jenkins
    ```
  - #### Create a persistent volume
    - jenkins-volume.yaml 작성   
    ```
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: jenkins-pv
          namespace: jenkins
        spec:
          storageClassName: jenkins-pv
          accessModes:
          - ReadWriteOnce
          capacity:
            storage: 20Gi
          persistentVolumeReclaimPolicy: Retain
          hostPath:
            path: /data/jenkins-volume/    
    ```
    - Run the following command to apply the spec     
    ```
    $ kubectl apply -f jenkins-volume.yaml    
    ```    
 - #### Create a service account   
   - jenkins-sa.yaml 작성
    ```
      ---
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: jenkins
        namespace: jenkins
      ---
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        annotations:
          rbac.authorization.kubernetes.io/autoupdate: "true"
        labels:
          kubernetes.io/bootstrapping: rbac-defaults
        name: jenkins
      rules:
      - apiGroups:
        - '*'
        resources:
        - statefulsets
        - services
        - replicationcontrollers
        - replicasets
        - podtemplates
        - podsecuritypolicies
        - pods
        - pods/log
        - pods/exec
        - podpreset
        - poddisruptionbudget
        - persistentvolumes
        - persistentvolumeclaims
        - jobs
        - endpoints
        - deployments
        - deployments/scale
        - daemonsets
        - cronjobs
        - configmaps
        - namespaces
        - events
        - secrets
        verbs:
        - create
        - get
        - watch
        - delete
        - list
        - patch
        - update
      - apiGroups:
        - ""
        resources:
        - nodes
        verbs:
        - get
        - list
        - watch
        - update
      ---
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        annotations:
          rbac.authorization.kubernetes.io/autoupdate: "true"
        labels:
          kubernetes.io/bootstrapping: rbac-defaults
        name: jenkins
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: jenkins
      subjects:
      - apiGroup: rbac.authorization.k8s.io
        kind: Group
        name: system:serviceaccounts:jenkins    
    ```
   - Run the following command to apply the spec
    ```
      $ kubectl apply -f jenkins-sa.yaml
    ```
#### Install Jenkins
   - jenkins-values.yaml
    ```
    storageClass: jenkins-pv
    
    serviceAccount:
    create: false
    # Service account name is autogenerated by default
    name: jenkins
    annotations: {}
    ```
   - Run the following command to apply the spec
    ```
      $ chart=jenkinsci/jenkins
      $ helm install jenkins -n jenkins -f jenkins-values.yaml $chart
      
      $ helm install jenkins jenkinsci/jenkins  -f values.yaml -n jenkins
    ```
   - Get your 'admin' user password by running:
    ```
      $ jsonpath="{.data.jenkins-admin-password}"
      $ secret=$(kubectl get secret -n jenkins jenkins -o jsonpath=$jsonpath)
      $ echo $(echo $secret | base64 --decode)    
    ```
   - Get the Jenkins URL to visit by running these commands in the same shell:
    ```
      $ jsonpath="{.spec.ports[0].nodePort}"
      $ NODE_PORT=$(kubectl get -n jenkins -o jsonpath=$jsonpath services jenkins)
      $ jsonpath="{.items[0].status.addresses[0].address}"
      $ NODE_IP=$(kubectl get nodes -n jenkins -o jsonpath=$jsonpath)
      $ echo http://$NODE_IP:$NODE_PORT/login    
    ```
#### Reference
 - https://nyyang.tistory.com/113
 - https://www.jenkins.io/doc/book/installing/kubernetes/
 - https://www.eksworkshop.com/intermediate/210_jenkins/deploy/
